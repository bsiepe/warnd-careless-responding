---
title: "Online Supplement 1: Visualizing Indices"
subtitle: "For the Manuscript: Identifying Careless Responding in Ecological Momentary Assessment: Inconsistent Signals from Different Detection Methods in the WARN-D Data"
author: 
 - name: Bj√∂rn S. Siepe
   orcid: 0000-0002-9558-4648
   affiliations: University of Marburg
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: true
    code-tools: true
    code-summary: "Show the code"
    fig-width: 8
    fig-height: 5
    fig-align: "center"
    embed-resources: true
execute:
  message: false
  warning: false
  eval: true # run code?
params:
  rerun: false  # define parameter if all large analyses should be rerun
---

# Background

In this document, we visualize and analyze all indices that were computed in `01_calculate_indices.qmd` *without* the reaction time (RT) indices.

We first load all relevant packages: 
```{r packages}
if(!require(pacman))
  install.packages("pacman")
pacman::p_load(
  "here",
  "ggplot2",
  "rrcov",
  "Hmisc",
  "sysfonts",
  "showtext",
  "ggh4x",
  "cowplot",
  "gtsummary",
  "gt",
  "future",
  "furrr",
  "dplyr",
  "tidyr",
  "vegan",
  "tibble",
  "purrr",
  "flextable",
  "patchwork"
)

source(here("scripts", "00_functions.R"))

# use color based on the Johnson palette from MetBrewer
fill_color <- "#132b69"

set.seed(35032)  
```


Relevant EMA items and their reaction times: 
```{r ema-itemss}
ema_items <-  c("sad_d", "stressed_d", "overwhelm_d", "nervous_d", "ruminate_d", "irritable_d", "cheerful_d", "motivated_d", "relaxed_d")
rt_ema_items <- paste0("rt_", ema_items)
```


For later visualizations, we also load the results of different model-based approaches. Here, we use the LPA without RT indices and the mixture IRT model:
```{r load-models}
lpa_res_no_rt <- readRDS(here::here("output", "data_profiles_without_time_indices.RDS"))
irt_res <- readRDS(here::here("output", "data_mixtureIRT.RDS"))
```

We load other results of the indices and the Jaccard similarity:
```{r}
#| label: load-flags
flag_df_no_rt <- readRDS(here::here("output", "flag_df_no_rt.RDS"))
lenient_flag_df_no_rt <- readRDS(here::here("output", "lenient_flag_df_no_rt.RDS"))
df_jaccard_spec_no_rt <- readRDS(here::here("output", "df_jaccard_spec_no_rt.RDS"))
```


# Summary

## Main Cutoffs
We have already defined the main default cutoffs that we use for the novel analysis without reaction time indices (see `01_calculate_indices.qmd`). We now check how many responses are marked as careless for each of the indices (in percent of all responses).


```{r}
#| label: main-cutoffs-table-no-rt

total_obs <- nrow(flag_df_no_rt)
non_missing_obs <- flag_df_no_rt |> 
  filter(!is.na(flag_sd_within)) |> 
  nrow()


df_jaccard_spec_no_rt |> 
    filter(
    sd_within_cutoff == 0.75 &
      average_response_time_cutoff == 2 &
      sd_response_time_cutoff == 1 &
      longstring_cutoff == 7 & 
      mode_cutoff == 5 &
      anto_cutoff == 0
  ) |> 
  mutate(across(contains("n_"),
                ~ round(./ non_missing_obs * 100, 2))) |> 
  rename(
    "Prop. Careless Single Hurdle" = n_careless_sum1, 
    "Prop. Careless Double Hurdle" = n_careless_sum2
  ) |> 
  knitr::kable()
```


We do the same with the most lenient cutoffs:
```{r}
#| label: lenient-cutoffs-table-no-rt

df_jaccard_spec_no_rt |> 
    filter(
    sd_within_cutoff == 0.75 &
      average_response_time_cutoff == 1.0 &
      sd_response_time_cutoff == 0.4 &
      longstring_cutoff == 6 & 
      mode_cutoff == 6 
  ) |> 
  mutate(across(contains("n_"),
                ~ round(./ non_missing_obs * 100, 2))) |> 
  rename(
    "Prop. Careless Single Hurdle" = n_careless_sum1, 
    "Prop. Careless Double Hurdle" = n_careless_sum2
  ) |> 
  knitr::kable()
```


For the LPA, only profile 1 is considered attentive. We can check the proportion of participants in each profile:
```{r}
#| label: lpa-cutoffs-table-no-rt

lpa_prop_df <- lpa_res_no_rt |> 
  left_join(irt_res, by = c("external_id", "counter")) |>
  left_join(flag_df_no_rt, by = c("external_id", "counter")) |> 
  mutate(across(where(is.logical), ~ as.integer(.))) |> 
  count(LPA_profile) |> 
  mutate(percent = n / sum(n))

lpa_prop_df |> 
  knitr::kable()

```
The proportion of non-attentive participants is therefore `r round(1 - lpa_prop_df$percent[lpa_prop_df$LPA_profile == 1], 4) * 100`%.`


This information is combined in the table in the supplementary materials.


## Multiverse Similarity
Instead of checking the correlation between affect items, we can instead check the overlap between carelessness flags based on the indices and the model-based indices across the multiverse. To do so, we use similarity metrics.

Visualize the results for both models and the single and double hurdle approach: 
```{r}
#| label: multiverse-similarity-plots
hurdles <- c("single", "double")
models <- c("lpa", "irt")
type <- "similarity"

# plots for similarities
for(model in models) {
  for(hurdle in hurdles) {
    sim_plot <- plot_similarity(df_jaccard_spec_no_rt , model, hurdle = hurdle)
    spec_plot <- plot_specification(df_jaccard_spec_no_rt , type = "similarity", model = model, hurdle = hurdle)
    
    mv_plot <- plot_grid(
      sim_plot,
      spec_plot,
      ncol = 1,
      rel_heights = c(1, 2),
      align = "h",
      axis = "b"
    )
    
    ggsave(
      paste0("mv_plot_similarity_no_rt", model, "_", hurdle, ".pdf"),
      mv_plot,
      device = "pdf",
      path = here::here("figures"),
      height = 10,
      width = 10
    )
  }
}
```



We can also check the highest similarity indices to the LPA across all specifications:
```{r}
#| label: multiverse-similarity-highest

df_jaccard_spec_no_rt |> 
  arrange(desc(jaccard_similarity1_lpa)) |> 
  head(10)
```



# Similarity Indices and Models

We attach the model results to the indices. We classify everyone with an LPA profile 1, and a mixture IRT class 1 as attentive. 
```{r}
#| label: attach-model
df_indices_models_no_rt <- lpa_res_no_rt |> 
  left_join(irt_res, by = c("external_id", "counter")) |> 
  left_join(flag_df_no_rt, by = c("external_id", "counter")) |> 
    mutate(across(where(is.logical), ~ as.integer(.))) |> 
    mutate(flag_lpa = ifelse(LPA_profile != 1, 1, 0),
           flag_irt = ifelse(mixtureIRT == 1, 0, 1)) |> 
   select(contains("flag")) |> 
  # recode to obtain single hurdle and multiple hurdle approach
  mutate(
    single_hurdle = if_else(flag_sum == 0, 0, 1),
    double_hurdle = if_else(flag_sum < 2, 0, 1)
  ) |> 
  # then remove raw sum
  select(!flag_sum)
  
```

## Jaccard Similarity of Indices and Model Results

We can visualize the classification of careless responding based on indices and and model results with a Jaccard similarity heatmap. 

### Main Specification

```{r jaccard-similarity}
jaccard_matrix <- vegan::vegdist(
  t(df_indices_models_no_rt),
  na.rm = TRUE,
  method = "jaccard",
  binary = TRUE
)
jaccard_matrix <- as.matrix(jaccard_matrix)

# convert dissimilarity to similarity
jaccard_sim_matrix <- 1-jaccard_matrix

# self-similarity
diag(jaccard_sim_matrix) <- 1

column_order <- c("Longstring", "Mode", "SD within", "Antonym", "Avg. RT", "SD RT", "Single", "Double", "LPA", "IRT")

similarity_plot_no_rt <- jaccard_sim_matrix |>
  as.data.frame() |>
  rownames_to_column(var = "Var1") |>
  pivot_longer(-Var1, names_to = "Var2", values_to = "Similarity") |>
  mutate(
    Var1 = case_when(
      Var1 == "flag_sd_within" ~ "SD within",
      Var1 == "flag_average_response_time" ~ "Avg. RT",
      Var1 == "flag_sd_response_time" ~ "SD RT",
      Var1 == "flag_longstring" ~ "Longstring",
      Var1 == "flag_mode" ~ "Mode",
      Var1 == "flag_anto" ~ "Antonym",
      Var1 == "flag_lpa" ~ "LPA",
      Var1 == "flag_irt" ~ "IRT",
      Var1 == "single_hurdle" ~ "Single",
      Var1 == "double_hurdle" ~ "Double",
      TRUE ~ Var1
    ),
    Var2 = case_when(
      Var2 == "flag_sd_within" ~ "SD within",
      Var2 == "flag_average_response_time" ~ "Avg. RT",
      Var2 == "flag_sd_response_time" ~ "SD RT",
      Var2 == "flag_longstring" ~ "Longstring",
      Var2 == "flag_mode" ~ "Mode",
      Var2 == "flag_anto" ~ "Antonym",
      Var2 == "flag_lpa" ~ "LPA",
      Var2 == "flag_irt" ~ "IRT",
      Var2 == "single_hurdle" ~ "Single",
      Var2 == "double_hurdle" ~ "Double",
      TRUE ~ Var2
    )) |> 
  mutate(
    Var1 = factor(Var1, levels = column_order),
    Var2 = factor(Var2, levels = rev(column_order)),
    text_color = if_else(Var1 == Var2, "white", "black")
  ) |>
  ggplot(aes(x = Var1, y = Var2, fill = Similarity)) +
  geom_tile(color = "white") +
  scale_fill_gradient(
    low = "white",
    high = fill_color,
    limit = c(0, 1),
    space = "Lab",
    name = "Jaccard\nSimilarity"
  ) +
  theme_bs() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    legend.justification = c(1, 0),
    legend.position = "none"
  ) +
  coord_fixed() +
  geom_text(aes(label = round(Similarity, 2), color = text_color), size = 3.8) +
  scale_color_identity()

similarity_plot_no_rt

ggsave("similarity_plot_no_rt.pdf", similarity_plot_no_rt, path = here::here("figures"),
       width = 7, height = 5)

```

We create the same plot with a row indicating the mean similarity for each method:
```{r similarity-plot-mean}
# Calculate mean similarities (excluding diagonal)
mean_similarities <- sapply(1:ncol(jaccard_sim_matrix), function(i) {
  col_vals <- jaccard_sim_matrix[, i]
  mean(col_vals[-i])  # exclude diagonal element
})
names(mean_similarities) <- colnames(jaccard_sim_matrix)

# main similarity data
similarity_data <- jaccard_sim_matrix |>
  as.data.frame() |>
  rownames_to_column(var = "Var1") |>
  pivot_longer(-Var1, names_to = "Var2", values_to = "Similarity") |>
  mutate(
    Var1 = case_when(
      Var1 == "flag_sd_within" ~ "SD within",
      Var1 == "flag_average_response_time" ~ "Avg. RT",
      Var1 == "flag_sd_response_time" ~ "SD RT",
      Var1 == "flag_longstring" ~ "Longstring",
      Var1 == "flag_mode" ~ "Mode",
      Var1 == "flag_anto" ~ "Antonym",
      Var1 == "flag_lpa" ~ "LPA",
      Var1 == "flag_irt" ~ "IRT",
      Var1 == "single_hurdle" ~ "Single",
      Var1 == "double_hurdle" ~ "Double",
      TRUE ~ Var1
    ),
    Var2 = case_when(
      Var2 == "flag_sd_within" ~ "SD within",
      Var2 == "flag_average_response_time" ~ "Avg. RT",
      Var2 == "flag_sd_response_time" ~ "SD RT",
      Var2 == "flag_longstring" ~ "Longstring",
      Var2 == "flag_mode" ~ "Mode",
      Var2 == "flag_anto" ~ "Antonym",
      Var2 == "flag_lpa" ~ "LPA",
      Var2 == "flag_irt" ~ "IRT",
      Var2 == "single_hurdle" ~ "Single",
      Var2 == "double_hurdle" ~ "Double",
      TRUE ~ Var2
    ),
    row_type = "main"
  )

# mean row data
mean_data <- data.frame(
  Var1 = "Mean",
  Var2 = names(mean_similarities),
  Similarity = as.numeric(mean_similarities),
  row_type = "mean"
) |>
  mutate(
    Var2 = case_when(
      Var2 == "flag_sd_within" ~ "SD within",
      Var2 == "flag_average_response_time" ~ "Avg. RT",
      Var2 == "flag_sd_response_time" ~ "SD RT",
      Var2 == "flag_longstring" ~ "Longstring",
      Var2 == "flag_mode" ~ "Mode",
      Var2 == "flag_anto" ~ "Antonym",
      Var2 == "flag_lpa" ~ "LPA",
      Var2 == "flag_irt" ~ "IRT",
      Var2 == "single_hurdle" ~ "Single",
      Var2 == "double_hurdle" ~ "Double",
      TRUE ~ Var2
    )
  )

# combine data
combined_data <- rbind(similarity_data, mean_data) |>
  mutate(
    text_color = case_when(
      row_type == "mean" ~ "black",
      Var1 == Var2 ~ fill_color,
      TRUE ~ "black"
    ),
    Var1 = factor(Var1, levels = c("Mean", rev(column_order))),
    Var2 = factor(Var2, levels = column_order)
  )


similarity_plot_mean_no_rt <- combined_data |>
  ggplot(aes(x = Var2, y = Var1, fill = Similarity)) +
  geom_tile(color = "white", size = ifelse(combined_data$row_type == "mean", 2, 0.5)) +
  # Add a thicker separator line above the mean row
  geom_hline(yintercept = 1.5, color = "#6d6d6e", linewidth = .5, linetype = 2) +
  scale_fill_gradient(
    low = "white",
    high = fill_color,  
    limit = c(0, 1),
    space = "Lab",
    name = "Jaccard\nSimilarity"
  ) +
  theme_bs() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0, hjust = 0),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    legend.justification = c(1, 0),
    legend.position = "none",
    axis.text.x.top = element_text(angle = 45, vjust = 0, hjust = 0),
    axis.text.x.bottom = element_blank(),
    plot.margin = margin(t = 5,r = 1,b = 5,l = 1)
  ) +
  scale_x_discrete(position = "top") +
  coord_fixed() +
  geom_text(aes(label = round(Similarity, 2), color = text_color), size = 3.8) +
  scale_color_identity()+
  labs(title = "Default")

similarity_plot_mean_no_rt

ggsave("similarity_plot_mean_no_rt.pdf", similarity_plot_mean_no_rt, path = here::here("figures"),
       width = 7, height = 5)
```


### Lenient/Sensitivity Specification

Instead of using the main specification, we can use the most lenient one here:
```{r}
df_indices_models_lenient_no_rt <- lpa_res_no_rt |> 
  left_join(irt_res, by = c("external_id", "counter")) |> 
  left_join(lenient_flag_df_no_rt, by = c("external_id", "counter")) |> 
    mutate(across(where(is.logical), ~ as.integer(.))) |> 
    mutate(flag_lpa = ifelse(LPA_profile != 2, 1, 0),
           flag_irt = ifelse(mixtureIRT == 1, 0, 1)) |> 
   select(contains("flag")) |> 
  # recode to obtain single hurdle and multiple hurdle approach
  mutate(
    single_hurdle = if_else(flag_sum == 0, 0, 1),
    double_hurdle = if_else(flag_sum < 2, 0, 1)
  ) |> 
  # then remove raw sum
  select(!flag_sum)
```

We then re-create the Jaccard similarity plot: 

```{r}
jaccard_matrix <- vegan::vegdist(
  t(df_indices_models_lenient_no_rt),
  na.rm = TRUE,
  method = "jaccard",
  binary = TRUE
)
jaccard_matrix <- as.matrix(jaccard_matrix)

# convert dissimilarity to similarity
jaccard_sim_matrix <- 1-jaccard_matrix

# self-similarity
diag(jaccard_sim_matrix) <- 1

column_order <- c("Longstring", "Mode", "SD within", "Antonym", "Avg. RT", "SD RT", "Single", "Double", "LPA", "IRT")

mean_similarities <- sapply(1:ncol(jaccard_sim_matrix), function(i) {
  col_vals <- jaccard_sim_matrix[, i]
  mean(col_vals[-i])  # exclude diagonal element
})
names(mean_similarities) <- colnames(jaccard_sim_matrix)

# main similarity data
similarity_data <- jaccard_sim_matrix |>
  as.data.frame() |>
  rownames_to_column(var = "Var1") |>
  pivot_longer(-Var1, names_to = "Var2", values_to = "Similarity") |>
  mutate(
    Var1 = case_when(
      Var1 == "flag_sd_within" ~ "SD within",
      Var1 == "flag_average_response_time" ~ "Avg. RT",
      Var1 == "flag_sd_response_time" ~ "SD RT",
      Var1 == "flag_longstring" ~ "Longstring",
      Var1 == "flag_mode" ~ "Mode",
      Var1 == "flag_anto" ~ "Antonym",
      Var1 == "flag_lpa" ~ "LPA",
      Var1 == "flag_irt" ~ "IRT",
      Var1 == "single_hurdle" ~ "Single",
      Var1 == "double_hurdle" ~ "Double",
      TRUE ~ Var1
    ),
    Var2 = case_when(
      Var2 == "flag_sd_within" ~ "SD within",
      Var2 == "flag_average_response_time" ~ "Avg. RT",
      Var2 == "flag_sd_response_time" ~ "SD RT",
      Var2 == "flag_longstring" ~ "Longstring",
      Var2 == "flag_mode" ~ "Mode",
      Var2 == "flag_anto" ~ "Antonym",
      Var2 == "flag_lpa" ~ "LPA",
      Var2 == "flag_irt" ~ "IRT",
      Var2 == "single_hurdle" ~ "Single",
      Var2 == "double_hurdle" ~ "Double",
      TRUE ~ Var2
    ),
    row_type = "main"
  )

# mean row data
mean_data <- data.frame(
  Var1 = "Mean",
  Var2 = names(mean_similarities),
  Similarity = as.numeric(mean_similarities),
  row_type = "mean"
) |>
  mutate(
    Var2 = case_when(
      Var2 == "flag_sd_within" ~ "SD within",
      Var2 == "flag_average_response_time" ~ "Avg. RT",
      Var2 == "flag_sd_response_time" ~ "SD RT",
      Var2 == "flag_longstring" ~ "Longstring",
      Var2 == "flag_mode" ~ "Mode",
      Var2 == "flag_anto" ~ "Antonym",
      Var2 == "flag_lpa" ~ "LPA",
      Var2 == "flag_irt" ~ "IRT",
      Var2 == "single_hurdle" ~ "Single",
      Var2 == "double_hurdle" ~ "Double",
      TRUE ~ Var2
    )
  )

# combine data
combined_data <- rbind(similarity_data, mean_data) |>
  mutate(
    text_color = case_when(
      row_type == "mean" ~ "black",
      Var1 == Var2 ~ fill_color,
      TRUE ~ "black"
    ),
    Var1 = factor(Var1, levels = c("Mean", rev(column_order))),
    Var2 = factor(Var2, levels = column_order)
  )


similarity_plot_mean_lenient_no_rt <- combined_data |>
  ggplot(aes(x = Var2, y = Var1, fill = Similarity)) +
  geom_tile(color = "white", size = ifelse(combined_data$row_type == "mean", 2, 0.5)) +
  # Add a thicker separator line above the mean row
  geom_hline(yintercept = 1.5, color = "#6d6d6e", linewidth = .5, linetype = 2) +
  scale_fill_gradient(
    low = "white",
    high = fill_color,  
    limit = c(0, 1),
    space = "Lab",
    name = "Jaccard\nSimilarity"
  ) +
  theme_bs() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0, hjust = 0),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    legend.justification = c(1, 0),
    legend.position = "none",
    axis.text.x.top = element_text(angle = 45, vjust = 0, hjust = 0),
    axis.text.x.bottom = element_blank(),
    plot.margin = margin(t = 5,r = 1,b = 5,l = 1)
  ) +
  scale_x_discrete(position = "top") +
  coord_fixed() +
  geom_text(aes(label = round(Similarity, 2), color = text_color), size = 3.8) +
  scale_color_identity()+
  labs(title = "Sensitivity")

similarity_plot_mean_lenient_no_rt

ggsave(
  "similarity_plot_mean_lenient_no_rt.pdf",
  similarity_plot_mean_lenient_no_rt,
  path = here::here("figures"),
  width = 7,
  height = 5
)
```

### Combine Specification Plots

We combine both Jaccard similarity mean plots in one plot: 

```{r}
#| fig-width: 11
#| fig-height: 6
#| label: jaccard-plots-combined

jaccard_plot_combined_no_rt <- similarity_plot_mean_no_rt + plot_spacer() +  similarity_plot_mean_lenient_no_rt + plot_layout(ncol = 3, widths = c(1, 0.05, 1))

ggsave(
  "jaccard_plot_combined_no_rt.pdf",
  jaccard_plot_combined_no_rt,
  path = here::here("figures"),
  width = 11,
  height = 6
)

jaccard_plot_combined_no_rt
```


# Session Info

```{r session-info}
pander::pander(sessionInfo())

```

